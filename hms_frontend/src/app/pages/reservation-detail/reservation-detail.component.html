<div *ngIf="service.loading()">Đang tải...</div>

<div *ngIf="service.error()" class="error">
  {{ service.error() }}
</div>

<div *ngIf="service.detail() as d" class="reservation-detail">
  <a (click)="goBack()" class="breadcrumb"> ← Quay lại đặt phòng của tôi </a>
  <div class="reservation-header">
    <div>
      <span class="label">Mã đặt phòng</span>
      <h1>{{ d.reservationCode }}</h1>

      <div class="status-group">
        <span class="badge status pending">
          <i class="fa fa-clock"></i>
          {{ getStatusText(d.status) }}
        </span>

        <span class="badge payment unpaid">
          <i class="fa fa-credit-card"></i>
          {{ getPaymentStatusText(d.paymentStatus || 'UNPAID') }}
        </span>
      </div>
    </div>

    <div class="total">
      <span>Tổng tiền </span>
      <strong>{{ formatVND(d.totalAmount) }}</strong>
    </div>
  </div>

  <div class="room-image" *ngIf="d.roomImage">
    <img [src]="d.roomImage" alt="Hình ảnh phòng" />
  </div>

  <h2 class="room-name">{{ d.roomTypeName }}</h2>

  <div class="info-grid">
    <div class="info-card">
      <h3><i class="fa fa-calendar"></i> Ngày đặt phòng</h3>

      <div class="row">
        <span>Nhận phòng</span>
        <strong>{{ d.checkInDate | date : "EEE, MMM d, y" }}</strong>
      </div>

      <div class="row">
        <span>Trả phòng</span>
        <strong>{{ d.checkOutDate | date : "EEE, MMM d, y" }}</strong>
      </div>

      <div class="row highlight">
        <span>Tổng số đêm</span>
        <strong>{{ totalNights() }} đêm</strong>
      </div>
    </div>

    <div class="info-card">
      <h3><i class="fa fa-user"></i> Thông tin khách</h3>

      <p>
        <strong>Họ tên</strong><br />
        {{ d.guestFullName }}
      </p>

      <p>
        <strong>Email</strong><br />
        {{ d.guestEmail }}
      </p>

      <p>
        <strong>Điện thoại</strong><br />
        {{ d.guestPhone || "Không có" }}
      </p>
    </div>
  </div>

  <div class="info-card">
    <h3><i class="fa fa-receipt"></i> Chi tiết giá</h3>

    <div class="row">
      <span>
        {{ formatVND(d.pricePerNight) }}
        × {{ totalNights() }} đêm
      </span>
      <strong>
        {{ formatVND(d.pricePerNight * totalNights()) }}
      </strong>
    </div>

    <div class="row">
      <span>Thuế & Phí dịch vụ</span>
      <strong>{{ formatVND(taxes()) }}</strong>
    </div>

    <div class="row total">
      <span>Tổng tiền</span>
      <strong>{{ formatVND(d.totalAmount) }}</strong>
    </div>
  </div>

  <div class="info-card">
    <h3><i class="fa fa-info-circle"></i> Thông tin đặt phòng</h3>

    <div class="row">
      <span>Ngày đặt</span>
      <strong>{{ d.createdAt | date }}</strong>
    </div>

    <div class="row">
      <span>Trạng thái đặt phòng</span>
      <span class="badge pending">{{ getStatusText(d.status) }}</span>
    </div>

    <div class="row">
      <span>Trạng thái thanh toán</span>
      <span class="badge pending">{{ getPaymentStatusText(d.paymentStatus) }}</span>
    </div>
  </div>

  <div class="actions">
    <button
      class="btn-cancel"
      [disabled]="!canCancel()"
      (click)="cancelBooking()"
    >
      <i class="fa fa-times"></i>
      Hủy đặt phòng
    </button>

    <button
      *ngIf="canPayNow()"
      class="btn-pay"
      (click)="payNow()"
    >
      <i class="fa fa-credit-card"></i>
      Thanh toán ngay (VNPay)
    </button>

    <div class="info-box payment-note" *ngIf="isCheckedIn()">
      <i class="fa fa-info-circle"></i>
      <div>
        <strong>Thanh toán khi trả phòng</strong>
        <p>
          Bạn đã nhận phòng. Thanh toán sẽ được thực hiện khi checkout (trả phòng).
        </p>
      </div>
    </div>

    <div class="lock-box" *ngIf="!canCancel() && !isCheckedIn()">
      <i class="fa fa-lock"></i>
      <div>
        <strong>Không thể chỉnh sửa</strong>
        <p>
          Đặt phòng đã xác nhận không thể chỉnh sửa. Vui lòng liên hệ hỗ trợ để thay đổi.
        </p>
      </div>
    </div>
  </div>

  <div class="info-card policy">
    <h3>Chính sách hủy phòng & thanh toán</h3>
    <ul>
      <li>Miễn phí hủy phòng trước 24 giờ check-in</li>
      <li>Không hoàn tiền nếu hủy trong vòng 24 giờ trước check-in</li>
      <li>Không hoàn tiền nếu không đến</li>
      <li><strong>Thanh toán trước:</strong> Thanh toán bằng VNPay khi đặt phòng (trạng thái Đã xác nhận)</li>
      <li><strong>Thanh toán sau:</strong> Thanh toán khi checkout nếu đã nhận phòng (trạng thái Đã nhận phòng)</li>
    </ul>
  </div>
</div>
